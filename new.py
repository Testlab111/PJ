import streamlit as st
import pandas as pd
import joblib
import datetime
import os
import folium
from streamlit_folium import st_folium

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="Bangsaen Traffic Predictor", page_icon="üöó", layout="centered")


# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• ---
@st.cache_resource
def load_assets():
    try:
        model = joblib.load('decision_tree_model.pkl')
        le_day = joblib.load('le_day.pkl')
        le_traffic = joblib.load('le_traffic.pkl')
        return model, le_day, le_traffic
    except Exception as e:
        st.error(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå: {e}")
        return None, None, None


# --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡πÅ‡∏ô‡∏ß‡∏ñ‡∏ô‡∏ô‡∏à‡∏£‡∏¥‡∏á) ---
def create_route_map(prediction_color):
    # ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
    map_center = [13.2885, 100.9190]
    m = folium.Map(location=map_center, zoom_start=15, tiles='OpenStreetMap')

    # ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏∏‡∏î‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏±‡∏ö‡∏•‡∏á‡∏ö‡∏ô "‡∏ñ‡∏ô‡∏ô‡∏•‡∏á‡∏´‡∏≤‡∏î‡∏ö‡∏≤‡∏á‡πÅ‡∏™‡∏ô" (‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)
    route_path = [
        [13.286472, 100.939028],  # 1. ‡πÅ‡∏¢‡∏Å‡∏Å‡∏≤‡πÅ‡∏•‡πá‡∏Ñ‡∏ã‡∏µ‡πà (‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏ñ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó)
        [13.286570, 100.938878],
        [13.286604, 100.938818],
        [13.286677, 100.938698],
        [13.286727, 100.938593],
        [13.286781, 100.938483],
        [13.286844, 100.938367],
        [13.286898, 100.938235],
        [13.286941, 100.938104],
        [13.286974, 100.937977],
        [13.287008, 100.937842],
        [13.287029, 100.937722],
        [13.287036, 100.937571],
        [13.287039, 100.937425],
        [13.287039, 100.937245],
        [13.287049, 100.937062],
        [13.287055, 100.936938],
        [13.287054, 100.936719],
        [13.287048, 100.936594],
        [13.287008, 100.937027],  # 3. ‡πÅ‡∏¢‡∏Å‡∏•‡∏±‡∏á‡πÄ‡∏•
        [13.286397, 100.926854],  # . ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≤‡∏á‡πÅ‡∏´‡∏•‡∏°‡∏ó‡∏≠‡∏á
        [13.285768, 100.923304],  # . ‡∏´‡∏ô‡πâ‡∏≤ ‡∏°.‡∏ö‡∏π‡∏£‡∏û‡∏≤
        [13.284665, 100.917672],  # . ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏ã‡∏≠‡∏¢‡∏ã‡∏µ‡πÑ‡∏ã‡∏î‡πå
        [13.283854, 100.915934]  # . ‡∏ß‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡πÅ‡∏™‡∏ô (‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á)

    ]

    # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ (Red/Green) ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ (Unknown) ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°
    line_color = '#808080'
    if prediction_color == 'Green':
        line_color = '#28A745'
    elif prediction_color == 'Red':
        line_color = '#FF0000'

    # ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏∂‡∏ö (‡πÄ‡∏û‡∏¥‡πà‡∏° weight ‡πÄ‡∏õ‡πá‡∏ô 12 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Google Maps)
    folium.PolyLine(
        route_path,
        color=line_color,
        weight=12,
        opacity=0.9
    ).add_to(m)

    # ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏à‡∏ö (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô)
    folium.Marker(
        [13.286458, 100.939046],
        popup="‡πÄ‡∏£‡∏¥‡πà‡∏°: ‡πÅ‡∏¢‡∏Å‡∏Å‡∏≤‡πÅ‡∏•‡πá‡∏Ñ‡∏ã‡∏µ‡πà",
        icon=folium.Icon(color='blue', icon='car', prefix='fa')
    ).add_to(m)

    folium.Marker(
        [13.283854, 100.915934],
        popup="‡∏à‡∏ö: ‡∏ß‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡πÅ‡∏™‡∏ô",
        icon=folium.Icon(color='red', icon='flag')
    ).add_to(m)

    return m


# --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---
model, le_day, le_traffic = load_assets()

if model:
    st.title("üöó ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏™‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏≤‡∏à‡∏£ ‡∏ö‡∏≤‡∏á‡πÅ‡∏™‡∏ô")
    st.write("‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á: ‡πÅ‡∏¢‡∏Å‡∏Å‡∏≤‡πÅ‡∏•‡πá‡∏Ñ‡∏ã‡∏µ‡πà ‚û°Ô∏è ‡∏ß‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡πÅ‡∏™‡∏ô")

    # ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    col1, col2 = st.columns(2)
    with col1:
        known_days = list(le_day.classes_)
        day_input = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", options=known_days)

    with col2:
        # ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 10:00 - 18:00
        available_times = []
        for h in range(10, 19):  # ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á 10 ‡∏ñ‡∏∂‡∏á 18
            available_times.append(datetime.time(h, 0))
            if h < 18:  # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà 30 ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡πÅ‡∏Ñ‡πà 17:30
                available_times.append(datetime.time(h, 30))

        time_input = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", options=available_times)

    predict_btn = st.button("üöÄ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏≤‡∏à‡∏£", use_container_width=True)

    # ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    if 'status_for_map' not in st.session_state:
        st.session_state.status_for_map = "Unknown"

    # ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•
    if predict_btn:
        dep_num = time_input.hour + (time_input.minute / 60.0)
        day_encoded = le_day.transform([day_input])[0]

        X = pd.DataFrame({
            'Day_Encoded': [day_encoded],
            'Departure_Num': [dep_num],
            'min': [20.0], 'max': [40.0], 'avg': [30.0]
        })

        res = model.predict(X)
        st.session_state.status_for_map = le_traffic.inverse_transform(res)[0]

        if st.session_state.status_for_map == 'Red':
            st.error(f"### üö© ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢: ‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô (Red)")
        else:
            st.success(f"### ‚úÖ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢: ‡∏Å‡∏≤‡∏£‡∏à‡∏£‡∏≤‡∏à‡∏£‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß (Green)")

    # ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    st.divider()
    st.subheader("üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á")
    my_map = create_route_map(st.session_state.status_for_map)
    st_folium(my_map, width=700, height=450)

    # ‡πÅ‡∏™‡∏î‡∏á Heatmap (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    if os.path.exists('traffic_heatmap_2025.png'):
        st.divider()
        st.subheader("üìä Heatmap ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á")
        st.image('traffic_heatmap_2025.png')